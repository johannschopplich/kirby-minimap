(function(){"use strict";const e=window.Vue;function O(){return window.panel}const T=()=>window.panel.plugins.viewButtons!==void 0;function U(){return T()?new Proxy({},{get(){throw new Error("Vuex store is not available. Are you using Kirby 5? Use the `useContent` composable instead.")}}):O().app.$store}function D(){const i=O(),n=U(),t=T(),o=w(t?()=>i.view.props.content:()=>n.getters["content/values"]()),a=w(t?()=>i.content.changes():()=>n.getters["content/changes"]()),s=w(t?()=>Object.keys(a.value).length>0:()=>n.getters["content/hasChanges"]()),d=t?i.content:new Proxy({},{get(){return()=>{}}});return{content:d,currentContent:o,contentChanges:a,hasChanges:s,update:async(m,p=!0)=>{if(!t&&m)for(const[v,g]of Object.entries(m))n.dispatch("content/update",[v,g]);const l=d.merge(m);p&&await d.save(l)}}}const w=e.computed;e.customRef,e.defineAsyncComponent,e.defineComponent,e.effectScope,e.getCurrentInstance;const A=e.getCurrentScope;e.h,e.inject,e.isProxy,e.isReactive,e.isReadonly,e.isRef,e.isShallow,e.markRaw;const N=e.nextTick;e.onActivated,e.onBeforeMount,e.onBeforeUnmount,e.onBeforeUpdate,e.onDeactivated,e.onErrorCaptured,e.onMounted,e.onRenderTracked,e.onRenderTriggered;const R=e.onScopeDispose;e.onServerPrefetch,e.onUnmounted,e.onUpdated,e.provide,e.proxyRefs,e.reactive,e.readonly;const y=e.ref;e.shallowReactive,e.shallowReadonly,e.shallowRef,e.toRaw,e.toRef,e.toRefs,e.triggerRef;const K=e.unref;e.useAttrs,e.useCssModule,e.useCssVars,e.useListeners,e.useSlots;const S=e.watch;e.watchEffect,e.watchPostEffect,e.watchSyncEffect;const z={heading:"title",text:"text",image:"image",gallery:"dashboard",video:"video",code:"code",quote:"quote",markdown:"markdown",list:"list-bullet",line:"divider",table:"menu"},M="k-panel-minimap-highlight";function V(){const i=O();function n(a){return z[a]??"box"}function t(a){var f;const{content:s,type:d}=a;if(!s||!d)return"";switch(d){case"heading":return B(s.text);case"text":return B(s.text);case"image":return s.alt||i.t("field.blocks.image.name");case"gallery":return(f=s.images)!=null&&f.length?`${i.t("field.blocks.gallery.name")} (${s.images.length})`:i.t("field.blocks.gallery.name");case"video":return B(s.caption)||i.t("field.blocks.video.name");case"code":return i.t("field.blocks.code.name")+(s.language?` (${s.language})`:"");case"quote":return B(s.text)||B(s.citation)||i.t("field.blocks.quote.name");case"markdown":return s.text?s.text.substring(0,50):i.t("field.blocks.markdown.name");case"list":return i.t("field.blocks.list.name");case"line":return i.t("field.blocks.line.name");case"table":return i.t("field.blocks.table.name");default:return d.charAt(0).toUpperCase()+d.slice(1)}}function o(a){var d;if(!a)return;const s=document.querySelector(`[data-id="${a}"]`);s&&(s.scrollIntoView({behavior:"smooth",block:"center"}),s.classList.add(M),setTimeout(()=>{s.classList.remove(M)},2e3),(d=window.matchMedia)!=null&&d.call(window,"(max-width: 60rem)").matches&&i.menu.close())}return{getBlockIcon:n,extractBlockText:t,scrollToBlock:o}}function B(i,n=50){return i?i.replace(/<[^>]*>/g,"").substring(0,n):""}function W(i,n,t,o){let a;const s=()=>{a==null||a(),a=void 0},d=(p,l,v,g)=>(p.addEventListener(l,v,g),()=>p.removeEventListener(l,v,g)),f=S(()=>G(i),p=>{s(),p&&(a=d(p,n,t,o))},{immediate:!0,flush:"post"}),m=()=>{f(),s()};return A()&&R(m),m}function Y(i={}){const n=new WeakMap,t=new Set;let o;const{root:a,rootMargin:s="0px",threshold:d=.5}=i,f=()=>{if(o){for(const l of t)o.unobserve(l);t.clear(),o=void 0}},m=(l,v)=>(o??(o=new IntersectionObserver(g=>{for(const b of g){const h=n.get(b.target);h&&h(b.isIntersecting)}},{root:a,rootMargin:s,threshold:d})),l&&(n.set(l,v),t.add(l),o.observe(l)),()=>{l&&(o==null||o.unobserve(l),t.delete(l),n.delete(l))}),p=l=>{l&&(o==null||o.unobserve(l),t.delete(l),n.delete(l))};return A()&&R(f),{observe:m,unobserve:p,disconnect:f}}function G(i){const n=K(i);return(n==null?void 0:n.$el)??n}function H(i,n,t,o,a,s,d,f){var m=typeof i=="function"?i.options:i;return n&&(m.render=n,m.staticRenderFns=t,m._compiled=!0),{exports:i,options:m}}const X={__name:"MinimapSidebar",setup(i){const n=["gap","hidden","line"],t="kirby$minimap",o=O(),{currentContent:a,contentChanges:s}=D(),{getBlockIcon:d,extractBlockText:f,scrollToBlock:m}=V(),p=y(),l=y(),v=y(localStorage.getItem(t)==="true"||!1),g=y({}),b=y([]),h=y([]),_=new Set,te=w(()=>Object.fromEntries(Object.entries(g.value).map(([c,r])=>{const u=s.value[c]??a.value[c],C=r.type==="blocks"&&Array.isArray(u)?u.map(k=>({...k,isActive:h.value.includes(k.id)})):[];return[c,{...r,blocks:C,isActive:b.value.includes(r.name)}]})));W(p,"click",c=>{var r;c.stopPropagation(),(r=l.value)!=null&&r.$el.contains(c.target)&&q()});const x=Y({rootMargin:"0px",threshold:0});S(v,c=>{localStorage.setItem(t,c),I(c)}),S([a,s],()=>{E()},{deep:!0}),S(()=>o.view.path,async()=>{j(),await L()},{immediate:!0}),P();function P(){I(v.value);const c=document.querySelector(".k-header"),r=c?c.getBoundingClientRect().top+Number.parseFloat(getComputedStyle(c).paddingTop):0;$("--minimap-top-offset",`${r}px`)}async function L(){o.isLoading&&await new Promise(r=>{const u=S(()=>o.isLoading,()=>{N(()=>u()),r()})});const c=await o.api.get("__minimap__/model-fields",{id:o.view.path},void 0,!0);for(const[r,u]of Object.entries(c))n.includes(u.type)&&delete c[r];g.value=c;for(const r of Object.keys(g.value)){const u=document.querySelector(`.k-field-name-${r}`);u&&x.observe(u,C=>{C?b.value.push(r):b.value=b.value.filter(k=>k!==r)})}E()}function j(){x&&(x.disconnect(),b.value=[],h.value=[],_.clear())}function E(){if(!x)return;const c=new Set;for(const u of Object.values(g.value)){if(u.type!=="blocks")continue;const C=s.value[u.name]??a.value[u.name];if(Array.isArray(C))for(const k of C){if(c.add(k.id),_.has(k.id))continue;const F=document.querySelector(`[data-id="${k.id}"]`);F&&(x.observe(F,oe=>{oe?h.value.push(k.id):h.value=h.value.filter(se=>se!==k.id)}),_.add(k.id))}}const r=[..._].filter(u=>!c.has(u));if(r.length){h.value=h.value.filter(u=>!r.includes(u));for(const u of r)_.delete(u)}}function q(){v.value=!v.value}function I(c=!1){$("--minimap-width",c?"var(--minimap-width-open)":"var(--minimap-width-closed)")}function $(c,r){document.documentElement.style.setProperty(c,r)}function ne(c){var u;const r=document.querySelector(`.k-field-name-${c}`);r&&(r.scrollIntoView({behavior:"smooth",block:"center"}),(u=window.matchMedia)!=null&&u.call(window,"(max-width: 60rem)").matches&&o.menu.close())}return{__sfc:!0,EXCLUDED_FIELD_TYPES:n,OPEN_STATE_STORAGE_KEY:t,panel:o,currentContent:a,contentChanges:s,getBlockIcon:d,extractBlockText:f,scrollToBlock:m,minimap:p,toggleButton:l,isOpen:v,fields:g,activeFieldNames:b,activeBlockIds:h,observedBlockIds:_,resolvedFields:te,observer:x,initializeMinimapUI:P,initializeMinimapContent:L,cleanupObservers:j,updateBlockObservers:E,toggle:q,updateMinimapWidth:I,setCssProperty:$,scrollToField:ne}}};var J=function(){var n=this,t=n._self._c,o=n._self._setupProxy;return t("nav",{ref:"minimap",staticClass:"k-panel-minimap"},[t("div",{staticClass:"k-panel-minimap-body"},[t("menu",[n._l(Object.values(o.resolvedFields),function(a){return[t("div",{key:a.name},[t("div",{staticClass:"k-panel-minimap-menu-item",class:[o.isOpen?"km-py-[var(--spacing-2)]":"km-py-[var(--spacing-3)]"],attrs:{"data-active":String(a.isActive)},on:{click:function(s){return o.scrollToField(a.name)}}},[o.isOpen?[t("span",{staticClass:"k-label-text km-font-[var(--font-semi)]"},[n._v(" "+n._s(a.label)+" ")]),a.required?t("span",{staticClass:"km-font-[var(--font-semi)] km-text-[var(--theme-color-600)] km-ms-[var(--spacing-1)]",attrs:{title:o.panel.t("field.required"),"data-theme":"negative"},domProps:{textContent:n._s("âœ¶")}}):n._e()]:t("div",{staticClass:"km-h-px km-flex-1 km-bg-[var(--color-text)]"})],2),a.type==="blocks"&&a.blocks.length?n._l(a.blocks,function(s,d){return t("div",{key:`${d}-${s.id}`,staticClass:"k-panel-minimap-menu-item km-flex km-py-[var(--spacing-1)] km-items-center km-gap-[var(--spacing-2)]",attrs:{"data-active":String(s.isActive)},on:{click:function(f){return o.scrollToBlock(s.id)}}},[t("k-icon",{attrs:{type:o.getBlockIcon(s.type)}}),t("span",{staticClass:"k-label-text"},[n._v(" "+n._s(o.extractBlockText(s))+" ")])],1)}):n._e()],2)]})],2)]),t("k-button",{ref:"toggleButton",staticClass:"k-panel-minimap-toggle",attrs:{icon:o.isOpen?"angle-right":"angle-left",title:o.isOpen?o.panel.t("collapse"):o.panel.t("expand"),size:"xs"}})],1)},Q=[],Z=H(X,J,Q);const ee=Z.exports;window.panel.plugin("johannschopplich/minimap",{use:[function(n){let t;n.mixin({mounted(){if(this.$options.name!=="k-panel-inside")return;const o=n.extend(ee);t=new o({parent:this}),t.$mount(),this.$el.appendChild(t.$el)},beforeDestroy(){this.$options.name==="k-panel-inside"&&t&&(t.$destroy(),t=void 0)}})}]})})();
