(function(){"use strict";const e=window.Vue;function x(){return window.panel}const E=()=>window.panel.plugins.viewButtons!==void 0;function N(){return E()?new Proxy({},{get(){throw new Error("Vuex store is not available. Are you using Kirby 5? Use the `useContent` composable instead.")}}):x().app.$store}function K(){const o=x(),t=N(),n=E(),a=w(n?()=>o.view.props.content:()=>t.getters["content/values"]()),s=w(n?()=>o.content.changes():()=>t.getters["content/changes"]()),i=w(n?()=>Object.keys(s.value).length>0:()=>t.getters["content/hasChanges"]()),l=n?o.content:new Proxy({},{get(){return()=>{}}});return{content:l,currentContent:a,contentChanges:s,hasChanges:i,update:async(m,c=!0)=>{if(!n&&m)for(const[f,p]of Object.entries(m))t.dispatch("content/update",[f,p]);const h=l.merge(m);c&&await l.save(h)}}}const w=e.computed;e.customRef,e.defineAsyncComponent,e.defineComponent,e.effectScope,e.getCurrentInstance;const P=e.getCurrentScope;e.h,e.inject,e.isProxy,e.isReactive,e.isReadonly,e.isRef,e.isShallow,e.markRaw,e.nextTick,e.onActivated,e.onBeforeMount,e.onBeforeUnmount,e.onBeforeUpdate,e.onDeactivated,e.onErrorCaptured,e.onMounted,e.onRenderTracked,e.onRenderTriggered;const j=e.onScopeDispose;e.onServerPrefetch,e.onUnmounted,e.onUpdated,e.provide,e.proxyRefs,e.reactive,e.readonly;const _=e.ref;e.shallowReactive,e.shallowReadonly,e.shallowRef,e.toRaw,e.toRef,e.toRefs,e.triggerRef;const U=e.unref;e.useAttrs,e.useCssModule,e.useCssVars,e.useListeners,e.useSlots;const M=e.watch;e.watchEffect,e.watchPostEffect,e.watchSyncEffect;const V={heading:"title",text:"text",image:"image",gallery:"dashboard",video:"video",code:"code",quote:"quote",markdown:"markdown",list:"list-bullet",line:"divider",table:"menu"},q="k-panel-minimap-highlight";function D(){const o=x();function t(s){return V[s]??"box"}function n(s){var g;const{content:i,type:l}=s;if(!i||!l)return"";switch(l){case"heading":return C(i.text);case"text":return C(i.text);case"image":return i.alt||o.t("field.blocks.image.name");case"gallery":return(g=i.images)!=null&&g.length?`${o.t("field.blocks.gallery.name")} (${i.images.length})`:o.t("field.blocks.gallery.name");case"video":return C(i.caption)||o.t("field.blocks.video.name");case"code":return o.t("field.blocks.code.name")+(i.language?` (${i.language})`:"");case"quote":return C(i.text)||C(i.citation)||o.t("field.blocks.quote.name");case"markdown":return i.text?i.text.substring(0,50):o.t("field.blocks.markdown.name");case"list":return o.t("field.blocks.list.name");case"line":return o.t("field.blocks.line.name");case"table":return o.t("field.blocks.table.name");default:return l.charAt(0).toUpperCase()+l.slice(1)}}function a(s){var l;if(!s)return;const i=document.querySelector(`[data-id="${s}"]`);i&&(i.scrollIntoView({behavior:"smooth",block:"center"}),i.classList.add(q),setTimeout(()=>{i.classList.remove(q)},2e3),(l=window.matchMedia)!=null&&l.call(window,"(max-width: 60rem)").matches&&o.menu.close())}return{getBlockIcon:t,extractBlockText:n,scrollToBlock:a}}function C(o,t=50){return o?o.replace(/<[^>]*>/g,"").substring(0,t):""}function z(o,t,n,a){let s;const i=()=>{s==null||s(),s=void 0},l=(c,h,f,p)=>(c.addEventListener(h,f,p),()=>c.removeEventListener(h,f,p)),g=M(()=>G(o),c=>{i(),c&&(s=l(c,t,n,a))},{immediate:!0,flush:"post"}),m=()=>{g(),i()};return P()&&j(m),m}function W(o={}){const t=new Map;let n;const{root:a,rootMargin:s="0px",threshold:i=.5}=o,l=()=>{if(n){for(const c of t.keys())n.unobserve(c);t.clear(),n=void 0}},g=(c,h)=>(n??(n=new IntersectionObserver(f=>{for(const p of f){const k=t.get(p.target);k&&k(p.isIntersecting)}},{root:a,rootMargin:s,threshold:i})),c&&(t.set(c,h),n.observe(c)),()=>{c&&(n==null||n.unobserve(c),t.delete(c))}),m=c=>{c&&(n==null||n.unobserve(c),t.delete(c))};return P()&&j(l),{observe:g,unobserve:m,disconnect:l}}function G(o){const t=U(o);return(t==null?void 0:t.$el)??t}const I=new Map;let L=!1;function H(){const o=x(),t=o.languages.find(s=>s.default);L||(o.events.on("model.update",n),o.events.on("page.changeSlug",n),o.events.on("page.changeTitle",n),L=!0);function n(){I.delete(o.view.path)}async function a(){const{path:s}=o.view;if(I.has(s))return I.get(s);const i=await o.api.get(s,{select:["id"],language:t==null?void 0:t.code},void 0,!0);return I.set(s,i.id),i.id}return{getModelId:a}}function Y(o,t,n,a,s,i,l,g){var m=typeof o=="function"?o.options:o;return t&&(m.render=t,m.staticRenderFns=n,m._compiled=!0),{exports:o,options:m}}const J={__name:"MinimapSidebar",setup(o){const t="kirby$minimap",n=x(),{currentContent:a,contentChanges:s}=K(),{getModelId:i}=H(),{getBlockIcon:l,extractBlockText:g,scrollToBlock:m}=D(),c=_(),h=_(),f=_(localStorage.getItem(t)==="true"||!1),p=_({}),k=_([]),y=_([]),S=new Set,te=w(()=>Object.fromEntries(Object.entries(p.value).filter(([r,u])=>u.type!=="hidden").map(([r,u])=>{const d=s.value[r]??a.value[r],b=u.type==="blocks"&&Array.isArray(d)?d.map(v=>({...v,isActive:y.value.includes(v.id)})):[];return[r,{...u,blocks:b,isActive:k.value.includes(u.name)}]})));M(f,r=>{localStorage.setItem(t,r),$(r)}),M([a,s],()=>{R()},{deep:!0}),z(c,"click",r=>{var u;r.stopPropagation(),(u=h.value)!=null&&u.$el.contains(r.target)&&F()});const B=W({rootMargin:"0px",threshold:0});(async()=>{$(f.value);const r=document.querySelector(".k-header"),u=r?r.getBoundingClientRect().top+Number.parseFloat(getComputedStyle(r).paddingTop):0;A("--minimap-top-offset",`${u}px`);const d=await i();p.value=await n.api.get("__minimap__/model-fields",{id:d??"site"},void 0,!0);for(const b of Object.keys(p.value)){const v=document.querySelector(`.k-field-name-${b}`);v&&B.observe(v,O=>{O?k.value.push(b):k.value=k.value.filter(T=>T!==b)})}R()})();function R(){if(!B)return;const r=new Set;for(const d of Object.values(p.value)){if(d.type!=="blocks")continue;const b=s.value[d.name]??a.value[d.name];if(Array.isArray(b))for(const v of b){if(r.add(v.id),S.has(v.id))continue;const O=document.querySelector(`[data-id="${v.id}"]`);O&&(B.observe(O,T=>{T?y.value.push(v.id):y.value=y.value.filter(oe=>oe!==v.id)}),S.add(v.id))}}const u=[...S].filter(d=>!r.has(d));if(u.length){y.value=y.value.filter(d=>!u.includes(d));for(const d of u)S.delete(d)}}function F(){f.value=!f.value}function $(r=!1){A("--minimap-width",r?"var(--minimap-width-open)":"var(--minimap-width-closed)")}function A(r,u){document.documentElement.style.setProperty(r,u)}function ne(r){var d;const u=document.querySelector(`.k-field-name-${r}`);u&&(u.scrollIntoView({behavior:"smooth",block:"center"}),(d=window.matchMedia)!=null&&d.call(window,"(max-width: 60rem)").matches&&n.menu.close())}return{__sfc:!0,OPEN_STATE_STORAGE_KEY:t,panel:n,currentContent:a,contentChanges:s,getModelId:i,getBlockIcon:l,extractBlockText:g,scrollToBlock:m,minimap:c,toggleButton:h,isOpen:f,fields:p,activeFieldNames:k,activeBlockIds:y,observedBlockIds:S,resolvedFields:te,observer:B,updateBlockObservers:R,toggle:F,updateMinimapWidth:$,setCssProperty:A,scrollToField:ne}}};var Q=function(){var t=this,n=t._self._c,a=t._self._setupProxy;return n("nav",{ref:"minimap",staticClass:"k-panel-minimap"},[n("div",{staticClass:"k-panel-minimap-body"},[n("menu",[t._l(Object.values(a.resolvedFields),function(s){return[n("div",{key:s.name},[n("div",{staticClass:"k-panel-minimap-menu-item",class:[a.isOpen?"km-py-[var(--spacing-2)]":"km-py-[var(--spacing-3)]"],attrs:{"data-active":String(s.isActive)},on:{click:function(i){return a.scrollToField(s.name)}}},[a.isOpen?[n("span",{staticClass:"k-label-text km-font-[var(--font-semi)]"},[t._v(" "+t._s(s.label)+" ")]),s.required?n("span",{staticClass:"km-font-[var(--font-semi)] km-text-[var(--theme-color-600)] km-ms-[var(--spacing-1)]",attrs:{title:a.panel.t("field.required"),"data-theme":"negative"},domProps:{textContent:t._s("âœ¶")}}):t._e()]:n("div",{staticClass:"km-h-px km-flex-1 km-bg-[var(--color-text)]"})],2),s.type==="blocks"&&s.blocks.length?t._l(s.blocks,function(i,l){return n("div",{key:`${l}-${i.id}`,staticClass:"k-panel-minimap-menu-item km-flex km-py-[var(--spacing-1)] km-items-center km-gap-[var(--spacing-2)]",attrs:{"data-active":String(i.isActive)},on:{click:function(g){return a.scrollToBlock(i.id)}}},[n("k-icon",{attrs:{type:a.getBlockIcon(i.type)}}),n("span",{staticClass:"k-label-text"},[t._v(" "+t._s(a.extractBlockText(i))+" ")])],1)}):t._e()],2)]})],2)]),n("k-button",{ref:"toggleButton",staticClass:"k-panel-minimap-toggle",attrs:{icon:a.isOpen?"angle-right":"angle-left",title:a.isOpen?a.panel.t("collapse"):a.panel.t("expand"),size:"xs"}})],1)},X=[],Z=Y(J,Q,X);const ee=Z.exports;window.panel.plugin("johannschopplich/minimap",{use:[function(t){t.mixin({mounted(){if(this.$options.name!=="k-panel-inside")return;const n=t.extend(ee),a=new n({parent:this});a.$mount(),this.$el.appendChild(a.$el)}})}]})})();
