(function(){"use strict";const e=window.Vue;function I(){return window.panel}const A=()=>window.panel.plugins.viewButtons!==void 0;function K(){return A()?new Proxy({},{get(){throw new Error("Vuex store is not available. Are you using Kirby 5? Use the `useContent` composable instead.")}}):I().app.$store}function V(){const o=I(),n=K(),t=A(),i=_(t?()=>o.view.props.content:()=>n.getters["content/values"]()),a=_(t?()=>o.content.changes():()=>n.getters["content/changes"]()),s=_(t?()=>Object.keys(a.value).length>0:()=>n.getters["content/hasChanges"]()),l=t?o.content:new Proxy({},{get(){return()=>{}}});return{content:l,currentContent:i,contentChanges:a,hasChanges:s,update:async(f,v=!0)=>{if(!t&&f)for(const[h,p]of Object.entries(f))n.dispatch("content/update",[h,p]);const r=l.merge(f);v&&await l.save(r)}}}const _=e.computed;e.customRef,e.defineAsyncComponent,e.defineComponent,e.effectScope,e.getCurrentInstance;const P=e.getCurrentScope;e.h,e.inject,e.isProxy,e.isReactive,e.isReadonly,e.isRef,e.isShallow,e.markRaw,e.nextTick,e.onActivated,e.onBeforeMount,e.onBeforeUnmount,e.onBeforeUpdate,e.onDeactivated,e.onErrorCaptured,e.onMounted,e.onRenderTracked,e.onRenderTriggered;const j=e.onScopeDispose;e.onServerPrefetch,e.onUnmounted,e.onUpdated,e.provide,e.proxyRefs,e.reactive,e.readonly;const C=e.ref;e.shallowReactive,e.shallowReadonly,e.shallowRef,e.toRaw,e.toRef,e.toRefs,e.triggerRef;const z=e.unref;e.useAttrs,e.useCssModule,e.useCssVars,e.useListeners,e.useSlots;const O=e.watch;e.watchEffect,e.watchPostEffect,e.watchSyncEffect;const W={heading:"title",text:"text",image:"image",gallery:"dashboard",video:"video",code:"code",quote:"quote",markdown:"markdown",list:"list-bullet",line:"divider",table:"menu"},q="k-panel-minimap-highlight";function Y(){const o=I();function n(a){return W[a]??"box"}function t(a){var m;const{content:s,type:l}=a;if(!s||!l)return"";switch(l){case"heading":return B(s.text);case"text":return B(s.text);case"image":return s.alt||o.t("field.blocks.image.name");case"gallery":return(m=s.images)!=null&&m.length?`${o.t("field.blocks.gallery.name")} (${s.images.length})`:o.t("field.blocks.gallery.name");case"video":return B(s.caption)||o.t("field.blocks.video.name");case"code":return o.t("field.blocks.code.name")+(s.language?` (${s.language})`:"");case"quote":return B(s.text)||B(s.citation)||o.t("field.blocks.quote.name");case"markdown":return s.text?s.text.substring(0,50):o.t("field.blocks.markdown.name");case"list":return o.t("field.blocks.list.name");case"line":return o.t("field.blocks.line.name");case"table":return o.t("field.blocks.table.name");default:return l.charAt(0).toUpperCase()+l.slice(1)}}function i(a){var l;if(!a)return;const s=document.querySelector(`[data-id="${a}"]`);s&&(s.scrollIntoView({behavior:"smooth",block:"center"}),s.classList.add(q),setTimeout(()=>{s.classList.remove(q)},2e3),(l=window.matchMedia)!=null&&l.call(window,"(max-width: 60rem)").matches&&o.menu.close())}return{getBlockIcon:n,extractBlockText:t,scrollToBlock:i}}function B(o,n=50){return o?o.replace(/<[^>]*>/g,"").substring(0,n):""}function G(o,n,t,i){let a;const s=()=>{a==null||a(),a=void 0},l=(v,r,h,p)=>(v.addEventListener(r,h,p),()=>v.removeEventListener(r,h,p)),m=O(()=>X(o),v=>{s(),v&&(a=l(v,n,t,i))},{immediate:!0,flush:"post"}),f=()=>{m(),s()};return P()&&j(f),f}function H(o={}){const n=new WeakMap,t=new Set;let i;const{root:a,rootMargin:s="0px",threshold:l=.5}=o,m=()=>{if(i){for(const r of t)i.unobserve(r);t.clear(),i=void 0}},f=(r,h)=>(i??(i=new IntersectionObserver(p=>{for(const w of p){const k=n.get(w.target);k&&k(w.isIntersecting)}},{root:a,rootMargin:s,threshold:l})),r&&(n.set(r,h),t.add(r),i.observe(r)),()=>{r&&(i==null||i.unobserve(r),t.delete(r),n.delete(r))}),v=r=>{r&&(i==null||i.unobserve(r),t.delete(r),n.delete(r))};return P()&&j(m),{observe:f,unobserve:v,disconnect:m}}function X(o){const n=z(o);return(n==null?void 0:n.$el)??n}const E=new Map;let L=!1;function J(){const o=I(),n=o.languages.find(a=>a.default);L||(o.events.on("model.update",t),o.events.on("page.changeSlug",t),o.events.on("page.changeTitle",t),L=!0);function t(){E.delete(o.view.path)}async function i(){const{path:a}=o.view;if(E.has(a))return E.get(a);const s=await o.api.get(a,{select:["id"],language:n==null?void 0:n.code},void 0,!0);return E.set(a,s.id),s.id}return{getModelId:i}}function Q(o,n,t,i,a,s,l,m){var f=typeof o=="function"?o.options:o;return n&&(f.render=n,f.staticRenderFns=t,f._compiled=!0),{exports:o,options:f}}const Z={__name:"MinimapSidebar",setup(o){const n=["gap","hidden","line"],t="kirby$minimap",i=I(),{currentContent:a,contentChanges:s}=V(),{getModelId:l}=J(),{getBlockIcon:m,extractBlockText:f,scrollToBlock:v}=Y(),r=C(),h=C(),p=C(localStorage.getItem(t)==="true"||!1),w=C({}),k=C([]),y=C([]),x=new Set,se=_(()=>Object.fromEntries(Object.entries(w.value).map(([c,u])=>{const d=s.value[c]??a.value[c],b=u.type==="blocks"&&Array.isArray(d)?d.map(g=>({...g,isActive:y.value.includes(g.id)})):[];return[c,{...u,blocks:b,isActive:k.value.includes(u.name)}]})));G(r,"click",c=>{var u;c.stopPropagation(),(u=h.value)!=null&&u.$el.contains(c.target)&&N()});const S=H({rootMargin:"0px",threshold:0});O(p,c=>{localStorage.setItem(t,c),R(c)}),O([a,s],()=>{$()},{deep:!0}),O(()=>i.view.path,async()=>{D(),await U()},{immediate:!0}),F();function F(){R(p.value);const c=document.querySelector(".k-header"),u=c?c.getBoundingClientRect().top+Number.parseFloat(getComputedStyle(c).paddingTop):0;T("--minimap-top-offset",`${u}px`)}async function U(){const c=await l(),u=await i.api.get("__minimap__/model-fields",{id:c??"site"},void 0,!0);for(const[d,b]of Object.entries(u))n.includes(b.type)&&delete u[d];w.value=u;for(const d of Object.keys(w.value)){const b=document.querySelector(`.k-field-name-${d}`);b&&S.observe(b,g=>{g?k.value.push(d):k.value=k.value.filter(M=>M!==d)})}$()}function D(){S&&(S.disconnect(),k.value=[],y.value=[],x.clear())}function $(){if(!S)return;const c=new Set;for(const d of Object.values(w.value)){if(d.type!=="blocks")continue;const b=s.value[d.name]??a.value[d.name];if(Array.isArray(b))for(const g of b){if(c.add(g.id),x.has(g.id))continue;const M=document.querySelector(`[data-id="${g.id}"]`);M&&(S.observe(M,ae=>{ae?y.value.push(g.id):y.value=y.value.filter(ce=>ce!==g.id)}),x.add(g.id))}}const u=[...x].filter(d=>!c.has(d));if(u.length){y.value=y.value.filter(d=>!u.includes(d));for(const d of u)x.delete(d)}}function N(){p.value=!p.value}function R(c=!1){T("--minimap-width",c?"var(--minimap-width-open)":"var(--minimap-width-closed)")}function T(c,u){document.documentElement.style.setProperty(c,u)}function ie(c){var d;const u=document.querySelector(`.k-field-name-${c}`);u&&(u.scrollIntoView({behavior:"smooth",block:"center"}),(d=window.matchMedia)!=null&&d.call(window,"(max-width: 60rem)").matches&&i.menu.close())}return{__sfc:!0,EXCLUDED_FIELD_TYPES:n,OPEN_STATE_STORAGE_KEY:t,panel:i,currentContent:a,contentChanges:s,getModelId:l,getBlockIcon:m,extractBlockText:f,scrollToBlock:v,minimap:r,toggleButton:h,isOpen:p,fields:w,activeFieldNames:k,activeBlockIds:y,observedBlockIds:x,resolvedFields:se,observer:S,initializeMinimapUI:F,initializeMinimapContent:U,cleanupObservers:D,updateBlockObservers:$,toggle:N,updateMinimapWidth:R,setCssProperty:T,scrollToField:ie}}};var ee=function(){var n=this,t=n._self._c,i=n._self._setupProxy;return t("nav",{ref:"minimap",staticClass:"k-panel-minimap"},[t("div",{staticClass:"k-panel-minimap-body"},[t("menu",[n._l(Object.values(i.resolvedFields),function(a){return[t("div",{key:a.name},[t("div",{staticClass:"k-panel-minimap-menu-item",class:[i.isOpen?"km-py-[var(--spacing-2)]":"km-py-[var(--spacing-3)]"],attrs:{"data-active":String(a.isActive)},on:{click:function(s){return i.scrollToField(a.name)}}},[i.isOpen?[t("span",{staticClass:"k-label-text km-font-[var(--font-semi)]"},[n._v(" "+n._s(a.label)+" ")]),a.required?t("span",{staticClass:"km-font-[var(--font-semi)] km-text-[var(--theme-color-600)] km-ms-[var(--spacing-1)]",attrs:{title:i.panel.t("field.required"),"data-theme":"negative"},domProps:{textContent:n._s("âœ¶")}}):n._e()]:t("div",{staticClass:"km-h-px km-flex-1 km-bg-[var(--color-text)]"})],2),a.type==="blocks"&&a.blocks.length?n._l(a.blocks,function(s,l){return t("div",{key:`${l}-${s.id}`,staticClass:"k-panel-minimap-menu-item km-flex km-py-[var(--spacing-1)] km-items-center km-gap-[var(--spacing-2)]",attrs:{"data-active":String(s.isActive)},on:{click:function(m){return i.scrollToBlock(s.id)}}},[t("k-icon",{attrs:{type:i.getBlockIcon(s.type)}}),t("span",{staticClass:"k-label-text"},[n._v(" "+n._s(i.extractBlockText(s))+" ")])],1)}):n._e()],2)]})],2)]),t("k-button",{ref:"toggleButton",staticClass:"k-panel-minimap-toggle",attrs:{icon:i.isOpen?"angle-right":"angle-left",title:i.isOpen?i.panel.t("collapse"):i.panel.t("expand"),size:"xs"}})],1)},te=[],ne=Q(Z,ee,te);const oe=ne.exports;window.panel.plugin("johannschopplich/minimap",{use:[function(n){let t;n.mixin({mounted(){if(this.$options.name!=="k-panel-inside")return;const i=n.extend(oe);t=new i({parent:this}),t.$mount(),this.$el.appendChild(t.$el)},beforeDestroy(){this.$options.name==="k-panel-inside"&&t&&(t.$destroy(),t=void 0)}})}]})})();
