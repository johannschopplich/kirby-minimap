(function(){"use strict";const e=window.Vue;function E(){return window.panel}const R=()=>window.panel.plugins.viewButtons!==void 0;function U(){return R()?new Proxy({},{get(){throw new Error("Vuex store is not available. Are you using Kirby 5? Use the `useContent` composable instead.")}}):E().app.$store}function D(){const i=E(),o=U(),n=R(),t=y(n?()=>i.view.props.content:()=>o.getters["content/values"]()),a=y(n?()=>i.content.changes():()=>o.getters["content/changes"]()),s=y(n?()=>Object.keys(a.value).length>0:()=>o.getters["content/hasChanges"]()),d=n?i.content:new Proxy({},{get(){return()=>{}}});return{content:d,currentContent:t,contentChanges:a,hasChanges:s,update:async(f,g=!0)=>{if(!n&&f)for(const[h,b]of Object.entries(f))o.dispatch("content/update",[h,b]);const u=d.merge(f);g&&await d.save(u)}}}const y=e.computed;e.customRef,e.defineAsyncComponent,e.defineComponent,e.effectScope,e.getCurrentInstance;const M=e.getCurrentScope;e.h,e.inject,e.isProxy,e.isReactive,e.isReadonly,e.isRef,e.isShallow,e.markRaw;const K=e.nextTick;e.onActivated,e.onBeforeMount,e.onBeforeUnmount,e.onBeforeUpdate,e.onDeactivated,e.onErrorCaptured,e.onMounted,e.onRenderTracked,e.onRenderTriggered;const j=e.onScopeDispose;e.onServerPrefetch,e.onUnmounted,e.onUpdated,e.provide,e.proxyRefs,e.reactive,e.readonly;const _=e.ref;e.shallowReactive,e.shallowReadonly,e.shallowRef,e.toRaw,e.toRef,e.toRefs,e.triggerRef;const z=e.unref;e.useAttrs,e.useCssModule,e.useCssVars,e.useListeners,e.useSlots;const O=e.watch;e.watchEffect,e.watchPostEffect,e.watchSyncEffect;const V={heading:"title",text:"text",image:"image",gallery:"dashboard",video:"video",code:"code",quote:"quote",markdown:"markdown",list:"list-bullet",line:"divider",table:"menu"},A="k-panel-minimap-highlight";function W(){const i=E();function o(a){return V[a]??"box"}function n(a){var p;const{content:s,type:d}=a;switch(d){case"heading":return x(s.text);case"text":return x(s.text);case"image":return s.alt||i.t("field.blocks.image.name");case"gallery":return(p=s.images)!=null&&p.length?`${i.t("field.blocks.gallery.name")} (${s.images.length})`:i.t("field.blocks.gallery.name");case"video":return x(s.caption)||i.t("field.blocks.video.name");case"code":return i.t("field.blocks.code.name")+(s.language?` (${s.language})`:"");case"quote":return x(s.text)||x(s.citation)||i.t("field.blocks.quote.name");case"markdown":return s.text?x(s.text):i.t("field.blocks.markdown.name");case"list":return i.t("field.blocks.list.name");case"line":return i.t("field.blocks.line.name");case"table":return i.t("field.blocks.table.name");default:return d.charAt(0).toUpperCase()+d.slice(1)}}function t(a){var d;if(!a)return;const s=document.querySelector(`[data-id="${a}"]`);s&&(s.scrollIntoView({behavior:"smooth",block:"center"}),s.classList.add(A),setTimeout(()=>{s.classList.remove(A)},2e3),(d=window.matchMedia)!=null&&d.call(window,"(max-width: 60rem)").matches&&i.menu.close())}return{getBlockIcon:o,extractBlockText:n,scrollToBlock:t}}function x(i,o=50){return i?i.replace(/<[^>]*>/g,"").substring(0,o):""}function Y(i,o,n,t){let a;const s=()=>{a==null||a(),a=void 0},d=(g,u,h,b)=>(g.addEventListener(u,h,b),()=>g.removeEventListener(u,h,b)),p=O(()=>H(i),g=>{s(),g&&(a=d(g,o,n,t))},{immediate:!0,flush:"post"}),f=()=>{p(),s()};return M()&&j(f),f}function G(i={}){const o=new WeakMap,n=new Set;let t;const{root:a,rootMargin:s="0px",threshold:d=.5}=i,p=()=>{if(t){for(const u of n)t.unobserve(u);n.clear(),t=void 0}},f=(u,h)=>(t??(t=new IntersectionObserver(b=>{for(const w of b){const k=o.get(w.target);k&&k(w.isIntersecting)}},{root:a,rootMargin:s,threshold:d})),u&&(o.set(u,h),n.add(u),t.observe(u)),()=>{u&&(t==null||t.unobserve(u),n.delete(u),o.delete(u))}),g=u=>{u&&(t==null||t.unobserve(u),n.delete(u),o.delete(u))};return M()&&j(p),{observe:f,unobserve:g,disconnect:p}}function H(i){const o=z(i);return(o==null?void 0:o.$el)??o}function X(i,o,n,t,a,s,d,p){var f=typeof i=="function"?i.options:i;return o&&(f.render=o,f.staticRenderFns=n,f._compiled=!0),{exports:i,options:f}}const J={__name:"MinimapSidebar",setup(i){const o=["gap","hidden","line"],n="kirby$minimap",t=E(),{currentContent:a,contentChanges:s}=D(),{getBlockIcon:d,extractBlockText:p,scrollToBlock:f}=W(),g=_(),u=_(),h=_(localStorage.getItem(n)==="true"||!1),b=_({}),w=_([]),k=_([]),C=new Set,ne=y(()=>Object.fromEntries(Object.entries(b.value).map(([r,l])=>{const c=s.value[r]??a.value[r],m=l.type==="blocks"&&Array.isArray(c)?c.map(v=>({...v,_icon:d(v.type),_text:p(v),_active:k.value.includes(v.id)})):[];return[r,{...l,blocks:m,_active:w.value.includes(l.name)}]})));Y(g,"click",r=>{var l;r.stopPropagation(),(l=u.value)!=null&&l.$el.contains(r.target)&&q()});const S=G({rootMargin:"0px",threshold:0});O(h,r=>{localStorage.setItem(n,r),I(r)}),O([a,s],()=>{$()},{deep:!0}),O([()=>t.view.path,()=>t.view.props.tab],async()=>{F(),await L()},{immediate:!0}),P();function P(){I(h.value);const r=document.querySelector(".k-header"),l=r?r.getBoundingClientRect().top+Number.parseFloat(getComputedStyle(r).paddingTop):0;T("--minimap-top-offset",`${l}px`)}async function L(){t.isLoading&&await new Promise(c=>{const m=O(()=>t.isLoading,()=>{K(()=>m()),c()})});const r=await t.api.get("__minimap__/model-fields",{id:t.view.path},void 0,!0);let l=r;if(t.view.props.tabs&&t.view.props.tabs.length>1){const c=N();l=Object.fromEntries(Object.entries(r).filter(([m])=>c.has(m)))}for(const[c,m]of Object.entries(l))o.includes(m.type)&&delete l[c];b.value=l;for(const c of Object.keys(b.value)){const m=document.querySelector(`.k-field-name-${c}`);m&&S.observe(m,v=>{v?w.value.push(c):w.value=w.value.filter(B=>B!==c)})}$()}function F(){S&&(S.disconnect(),w.value=[],k.value=[],C.clear())}function $(){if(!S)return;const r=new Set;for(const c of Object.values(b.value)){if(c.type!=="blocks")continue;const m=s.value[c.name]??a.value[c.name];if(Array.isArray(m))for(const v of m){if(r.add(v.id),C.has(v.id))continue;const B=document.querySelector(`[data-id="${v.id}"]`);B&&(S.observe(B,se=>{se?k.value.push(v.id):k.value=k.value.filter(ie=>ie!==v.id)}),C.add(v.id))}}const l=[...C].filter(c=>!r.has(c));if(l.length){k.value=k.value.filter(c=>!l.includes(c));for(const c of l)C.delete(c)}}function q(){h.value=!h.value}function I(r=!1){T("--minimap-width",r?"var(--minimap-width-open)":"var(--minimap-width-closed)")}function T(r,l){document.documentElement.style.setProperty(r,l)}function N(){const r=new Set;for(const l of t.view.props.tab.columns)for(const c of Object.values(l.sections))if(c.type==="fields")for(const m of Object.values(c.fields))r.add(m.name);return r}function oe(r){var c;const l=document.querySelector(`.k-field-name-${r}`);l&&(l.scrollIntoView({behavior:"smooth",block:"center"}),(c=window.matchMedia)!=null&&c.call(window,"(max-width: 60rem)").matches&&t.menu.close())}return{__sfc:!0,EXCLUDED_FIELD_TYPES:o,OPEN_STATE_STORAGE_KEY:n,panel:t,currentContent:a,contentChanges:s,getBlockIcon:d,extractBlockText:p,scrollToBlock:f,minimap:g,toggleButton:u,isOpen:h,fields:b,activeFieldNames:w,activeBlockIds:k,observedBlockIds:C,resolvedFields:ne,observer:S,initializeMinimapUI:P,initializeMinimapContent:L,cleanupObservers:F,updateBlockObservers:$,toggle:q,updateMinimapWidth:I,setCssProperty:T,extractCurrentTabFieldNames:N,scrollToField:oe}}};var Q=function(){var o=this,n=o._self._c,t=o._self._setupProxy;return n("nav",{ref:"minimap",staticClass:"k-panel-minimap"},[n("div",{staticClass:"k-panel-minimap-body"},[n("menu",[o._l(Object.values(t.resolvedFields),function(a){return[n("div",{key:a.name},[n("div",{staticClass:"k-panel-minimap-menu-item",class:[t.isOpen?"km-py-[var(--spacing-2)]":"km-py-[var(--spacing-3)]"],attrs:{"data-active":String(a._active)},on:{click:function(s){return t.scrollToField(a.name)}}},[t.isOpen?[n("span",{staticClass:"k-label-text km-font-[var(--font-semi)]"},[o._v(" "+o._s(a.label)+" ")]),a.required?n("span",{staticClass:"km-font-[var(--font-semi)] km-text-[var(--theme-color-600)] km-ms-[var(--spacing-1)]",attrs:{title:t.panel.t("field.required"),"data-theme":"negative"},domProps:{textContent:o._s("âœ¶")}}):o._e()]:n("div",{staticClass:"km-h-px km-flex-1 km-bg-[var(--color-text)]"})],2),a.type==="blocks"&&a.blocks.length?o._l(a.blocks,function(s,d){return n("div",{key:`${d}-${s.id}`,staticClass:"k-panel-minimap-menu-item km-flex km-py-[var(--spacing-1)] km-items-center km-gap-[var(--spacing-2)]",attrs:{"data-active":String(s._active)},on:{click:function(p){return t.scrollToBlock(s.id)}}},[n("k-icon",{attrs:{type:s._icon}}),n("span",{staticClass:"k-label-text"},[o._v(" "+o._s(s._text)+" ")])],1)}):o._e()],2)]})],2)]),n("k-button",{ref:"toggleButton",staticClass:"k-panel-minimap-toggle",attrs:{icon:t.isOpen?"angle-right":"angle-left",title:t.isOpen?t.panel.t("collapse"):t.panel.t("expand"),size:"xs"}})],1)},Z=[],ee=X(J,Q,Z);const te=ee.exports;window.panel.plugin("johannschopplich/minimap",{use:[function(o){let n;o.mixin({mounted(){if(this.$options.name!=="k-panel-inside")return;const t=o.extend(te);n=new t({parent:this}),n.$mount(),this.$el.appendChild(n.$el)},beforeDestroy(){this.$options.name==="k-panel-inside"&&n&&(n.$destroy(),n=void 0)}})}]})})();
